<!-- repo_detail.html (READY TO COPY) -->
{{ define "repo_detail_page" }}
  {{ template "layout" . }}
{{ end }}

{{ define "content" }}
<div class="d-flex justify-content-between align-items-center mb-3">
  <div>
    <h1 class="h3 mb-0">{{ .Repo.Namespace }}/{{ .Repo.Name }}</h1>
    <div class="text-muted small">Latest snapshots and derived deltas</div>
  </div>
  <a class="btn btn-outline-secondary" href="/repos">Back</a>
</div>

<!-- Pills (mobile only) -->
<div class="d-lg-none mb-3">
  <div class="nav nav-pills gap-2" role="tablist" aria-label="Repo detail view">
    <button type="button"
            class="nav-link active"
            data-pp-view="snapshots"
            aria-pressed="true">
      Snapshots
    </button>
    <button type="button"
            class="nav-link"
            data-pp-view="deltas"
            aria-pressed="false">
      Deltas
    </button>
  </div>
  <div class="form-text mt-2">On desktop both views are shown side-by-side.</div>
</div>

<!-- Single-source-of-truth content (rendered once) -->
<div class="row g-3" id="pp-repo-detail">
  <div class="col-12 col-lg-6" data-pp-panel="snapshots">
    <div class="card">
      <div class="card-header">Snapshots (latest 50)</div>
      <div class="card-body">
        {{ if .Snaps }}
        <div class="d-flex flex-column gap-2">
          {{ range .Snaps }}
          <div class="border rounded p-3">
            <div class="d-flex justify-content-between align-items-start gap-2">
              <div class="min-w-0">
                <div class="text-muted small">Timestamp (UTC)</div>
                <div class="fw-semibold text-break">{{ .TSUTC }}</div>
              </div>
              <span class="badge text-bg-light">Snapshot</span>
            </div>

            <div class="mt-3 d-flex flex-wrap gap-4">
              <div>
                <div class="text-muted small">Pulls</div>
                <div class="fw-semibold">{{ .PullCount }}</div>
              </div>
              <div>
                <div class="text-muted small">Stars</div>
                <div class="fw-semibold">{{ .StarCount }}</div>
              </div>
              {{ if .LastUpdate }}
              <div>
                <div class="text-muted small">Last updated</div>
                <div class="fw-semibold text-break">{{ .LastUpdate }}</div>
              </div>
              {{ end }}
            </div>
          </div>
          {{ end }}
        </div>
        {{ else }}
        <div class="text-muted">No snapshots yet.</div>
        {{ end }}
      </div>
    </div>
  </div>

  <div class="col-12 col-lg-6" data-pp-panel="deltas">
    <div class="card">
      <div class="card-header">Deltas (latest 50)</div>
      <div class="card-body">
        {{ if .Deltas }}
        <div class="d-flex flex-column gap-2">
          {{ range .Deltas }}
          <div class="border rounded p-3">
            <div class="d-flex justify-content-between align-items-start gap-2">
              <div class="min-w-0">
                <div class="text-muted small">To (UTC)</div>
                <div class="fw-semibold text-break">{{ .ToTSUTC }}</div>
              </div>
              <span class="badge {{ if ge .Delta 0 }}text-bg-success{{ else }}text-bg-warning{{ end }}">
                {{ if ge .Delta 0 }}Delta{{ else }}Negative delta{{ end }}
              </span>
            </div>

            <div class="mt-3 d-flex flex-wrap gap-4">
              <div>
                <div class="text-muted small">Î” Pulls</div>
                <div class="fw-semibold">{{ .Delta }}</div>
              </div>
              <div>
                <div class="text-muted small">Per hour</div>
                <div class="fw-semibold">{{ printf "%.2f" .PerHour }}</div>
              </div>
              <div>
                <div class="text-muted small">Seconds</div>
                <div class="fw-semibold">{{ .Seconds }}</div>
              </div>
            </div>

            <div class="mt-2 text-muted small">
              From: {{ .FromTSUTC }}
            </div>
          </div>
          {{ end }}
        </div>
        {{ else }}
        <div class="text-muted">No deltas yet.</div>
        {{ end }}
      </div>
    </div>
  </div>
</div>

<script>
(function () {
  // Only needed on mobile; desktop shows both columns anyway.
  const root = document.getElementById("pp-repo-detail");
  if (!root) return;

  const mediaLg = window.matchMedia("(min-width: 992px)"); // Bootstrap lg

  const pills = document.querySelectorAll('[data-pp-view]');
  const panels = {
    snapshots: root.querySelector('[data-pp-panel="snapshots"]'),
    deltas: root.querySelector('[data-pp-panel="deltas"]'),
  };

  function setActive(view) {
    // Update pills
    pills.forEach(btn => {
      const isActive = btn.getAttribute("data-pp-view") === view;
      btn.classList.toggle("active", isActive);
      btn.setAttribute("aria-pressed", isActive ? "true" : "false");
    });

    // Desktop: always show both
    if (mediaLg.matches) {
      panels.snapshots.classList.remove("d-none");
      panels.deltas.classList.remove("d-none");
      return;
    }

    // Mobile: show only selected
    panels.snapshots.classList.toggle("d-none", view !== "snapshots");
    panels.deltas.classList.toggle("d-none", view !== "deltas");
  }

  // Click handling
  pills.forEach(btn => {
    btn.addEventListener("click", () => {
      const view = btn.getAttribute("data-pp-view") || "snapshots";
      // Optional: persist in URL hash
      try { history.replaceState(null, "", "#" + view); } catch (e) {}
      setActive(view);
    });
  });

  // Initial state: hash > default snapshots
  let initial = "snapshots";
  const hash = (location.hash || "").replace("#", "");
  if (hash === "deltas" || hash === "snapshots") initial = hash;

  setActive(initial);

  // React to viewport changes (rotate phone etc.)
  mediaLg.addEventListener("change", () => {
    // Keep current active pill if present, else snapshots
    const activeBtn = document.querySelector('[data-pp-view].active');
    const view = activeBtn ? activeBtn.getAttribute("data-pp-view") : "snapshots";
    setActive(view || "snapshots");
  });
})();
</script>
{{ end }}
